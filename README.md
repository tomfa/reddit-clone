# Reddit clone

This is a [Next.js](https://nextjs.org/) based reddit clone, using Google
authentication through [NextAuth](https://next-auth.js.org/). Webapp talks to
NextJS API using [Apollo GraphQL](https://www.apollographql.com/), and data is
stored in [Firestore](https://firebase.google.com/docs/firestore).

> Demo: [reddit-clone-tomfa.vercel.app](https://reddit-clone-tomfa.vercel.app/)

#### Thoughts on tech choice

If you want a **different database**, you can quite easily replace Firebase completely, as it's isolated to a small part
of the backend. See Configuration section below

If you instead want to keep Firestore, you can **embrace Firebase** to get many
perks: get realtime updates, eliminate the need for a backend, lower costs
and increase performance by using Firebase Auth and making storage calls from
frontend by adding Firestore security rules. This would require a larger rewrite.

## Setup

- Copy `.env` to `.env.local`. We can safely store secrets here without
  having them commited.

- Set `JWT_SECRET` to a random long string

### Auth and Firebase

1. Create a [Firebase project](https://console.firebase.google.com/).
2. In Firebase, create and download new private key. You can do this from Project Setting
   -> Service acccounts. From this file, copy over the following attributes to your `.env.local` file

   - `project_id` -> `FIREBASE_PROJECT_ID`
   - `private_key` -> `FIREBASE_PRIVATE_KEY`
   - `client_email` -> `FIREBASE_CLIENT_EMAIL`

3. Go to [Google Cloud console: Credentials](https://console.cloud.google.com/apis/credentials) for your project

   Find the existing OAuth2.0 web client (autogenerated), and click the
   Download icon. Add them to your `.env.local` file

   - `Client ID` -> `GOOGLE_CLIENT_ID`
   - `Client secret` -> `GOOGLE_CLIENT_SECRET`

   Then click the Edit icon, and add:

   - Authorised JavaScript origins: `http://localhost:3000`

   - Authorised redirect URIs: `http://localhost:3000/api/auth/callback/google`

   _Replace "http://localhost:3000" with your domain when deploying the app to
   new domains._

**Note: When running the first time, the app will display errors about disabled
services or missing indexes.** The errors will link you to the related places
in Firebase for enabling these services or creating indexes.

![](https://user-images.githubusercontent.com/1502702/136714653-ecdc9c0b-3eb0-4dd8-9b85-8bbba3a6c6ed.png)

_When seeing errors like the one above, click the link to enable database or create indexes._

### Deploying to Vercel

[![Deploy with Vercel](https://vercel.com/button)](https://vercel.com/new/clone?repository-url=https%3A%2F%2Fgithub.com%2Ftomfa%2Freddit-clone&env=NEXTAUTH_URL,GOOGLE_CLIENT_ID,GOOGLE_CLIENT_SECRET,FIREBASE_PROJECT_ID,FIREBASE_CLIENT_EMAIL,FIREBASE_PRIVATE_KEY,JWT_SECRET&project-name=reddit&repo-name=reddit-clone)

1. Click the button above to copy and deploy to Vercel.
2. In the guide, populate environment variables from your `.env.local`.
3. After having set up a Vercel app with a domain, go back to step 3 in the previous
   section and add new domains to Authorised JavaScript origins and redirect urls.
4. In Vercel, set the domain of the app to `NEXTAUTH_URL` env var.

## Development

```bash
yarn start
```

_This will start app at [localhost:3000](http://localhost:3000)_

### Making API changes

The Webapp talks to our API via a GraphQL, using Documents and React hooks
autogenerated by [codegen](https://www.graphql-code-generator.com/) and [gqlg](https://www.npmjs.com/package/gqlg).

To make API changes:

- Update `./graphql/schema.graphql`
- Run `yarn schema:generate`

Typescript errors can then be found with `yarn tsc -b`, which should notify you of
most code that needs an update.

## Configuration

### Change logo

The logo/title "raidit" can be overriden by setting env var `NEXT_PUBLIC_TITLE`.

### Adding / removing categories

These are set in `lib/config.ts`. Simply update them there.

### Changing database

Everything related to using Firestore as a database is isolated to the following
two files.

`backend/db/index.ts` and `backend/db/firebase.ts`

If you want to replace the database, you need only reimplement these methods.

### Restricting domains for login

If you want to restrict login to users with `@example.com` domain, specify
`ALLOWED_SIGNUP_DOMAINS` in `.env`. You can use a comma `,` separator to specify
multiple domains.

By default, all domains are granted access.

### Changing authentication methods

You can add Auth0, SMS or email login, by adding
[NextAuth providers](https://next-auth.js.org/) in `pages/api/auth/[...nextauth].ts`.
